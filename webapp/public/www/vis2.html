<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network Analysis</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">
    <style>
        #right-side-bar{
            position: fixed;
            top: 0;
            right:0;
            margin-top:65px;
            margin-right:10px;
            background: #FFF;
            text-align: center;
            padding-top:2px;
            padding-left: 1.2%;

            min-height: 10%;
            min-width: 5%;
            font-size: 1rem;
        }
        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        #container {
            position: absolute;
            width: 80%;
            height: 80%;
        }
        .navbar{
            border-bottom: 0.5px solid #999;
            border-top: 2px solid orange;
        }
        #stop{
            margin-left:10px;
            margin-botton:1px;
            font-size: 8pt;
            background: #f44556;
            border:none;

        }
        #total-nodes{
            margin-left: 10px;
            margin-top:6px;
            font-size: 8pt;
            float: left;
        }

        #total-edges{
            margin-left: 10px;
            margin-top:6px;
            font-size: 8pt;
            float: left;
        }
        #density{
            margin-left: 10px;
            margin-top:6px;
            font-size: 8pt;
            float: left;
        }
        0.0007501678768784844
        #stop:hover{
            background-color: #f44336;
            color: white;
        }
        .reset{
            margin-left:10px;
            padding:0.5px 11px 1px 0.5px;
            font-size: 9pt !important;
            background-color:#008Cf4;
            border:none;
            color:#000 !important;
            text-decoration: none;
        }
        .reset:hover{
            background-color: #008CBA;
            color: white !important;
            text-decoration: none;
        }
        .title{
            float:left;
        }
        #sidebar {
                position: fixed;
                bottom: 0;
                background: #FFF;
                float:left;
                padding-left:5%;
                margin-bottom: 75px;
                min-height: 10%;
                min-width: 80%;
                background-color:#fff;
        }
        #legend {
                position: fixed;
                top: 0;
                left:0;
                margin-top:100px;
                background: #FFF;
                text-align: center;
                padding-top:1px;
                padding-left: 1%;
                border: solid 1px #ccc;
                min-height: 10%;
                min-width: 5%;
                font-size: 7pt;
        }

        #right-side-bar{
            position: fixed;
            top: 0;
            right:0;
            margin-top:65px;
            margin-right:10px;
            background: #FFF;
            text-align: center;
            padding-top:2px;
            padding-left: 1.2%;
            float:left;
            min-height: 10%;
            min-width: 5%;
            font-size: 0.6rem;
        }
        .list-group{
            float:left;
            margin-left:5px;
        }
    /*charts*/
    .chart {
        display: inline-block;
        height: 50px;
        margin-bottom: 10px;
        float: left;
        background-color:#fff;

  }
        #legend {
            position: fixed;
            top: 0;
            left:0;
            margin-top:120px;
            background-color:#fff;
            text-align: center;
            padding-top:2px;
            padding-left: 15px;
            padding-right: 5px;
            border: solid 1px #ccc;
            min-height: 10%;
            min-width: 5%;
            font-size: 7pt;
        }
  .reset {
    padding-left: 1em;
    font-size: smaller;
    color: #ccc;
  }

  .background.bar {
    fill: #ccc;

  }

  .foreground.bar {
    fill: #E1ECF4;
  }

  .brush-handle {
    fill: #eee;
    stroke: #666;
  }

  #hour-chart {
    width: 260px;
  }

  #delay-chart {
    width: 230px;
  }

  #distance-chart {
    width: 430px;
  }

  #date-chart {
    width: 920px;
  }

  #flight-list {
    min-height: 1024px;
  }

  #flight-list .date,
  #flight-list .day {
    margin-bottom: .4em;
  }

  #flight-list .flight {
    line-height: 1.5em;
    background: #eee;
    width: 925px;
    margin-bottom: 1px;
  }

  #flight-list .time {
    color: #999;
  }

  #flight-list .flight div {
    display: inline-block;
  }

  #flight-list div.time {
    width: 100px;
    text-align: left;
  }

  #flight-list div.origin {
    width: 50px;
    text-align: right;
    padding-right: 15px;
  }

  #flight-list div.destination {
    width: 100px;
    text-align: left;
    padding-left: 15px;
  }

  #flight-list div.distance {
    width: 100px;
    text-align: left;
  }

  #flight-list div.delay {
    width: 120px;
    padding-right: 0px;
    text-align: right;
  }

  #flight-list .early {
    color: green;
  }

  aside {
    position: absolute;
    left: 740px;
    font-size: smaller;
    width: 220px;
  }

#vis-title {
    display:inline-block; float:left;
    z-index: 999999;
    position: absolute;
}
#vis-title > h5 {
    float: left;
    margin-right: 5px;
    margin-left: 5px;
}
    </style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/sigma.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.forceAtlas2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.noverlap.min.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js" charset="utf-8"></script>-->
<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.js"></script>-->
<!--<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js' defer></script>-->
<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>-->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.4.3/crossfilter.min.js' defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reductio/0.6.3/reductio.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.9/dc.min.js"></script>-->
<script src='https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.23.1/babel.min.js' defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.6/cytoscape.js"></script>
<script src="jsnetworkx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<!--<script src='../js/vis2.js' defer></script>-->

</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01"
            aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
            <a class="navbar-brand" href="#"><img src="..\image\logo.png" height="30" width="100"></a>
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="vis1">Cluster of Tags</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="vis2">Network analysis<span class="sr-only">(current)</span></a>
                </li>
            </ul>

        </div>
    </nav>
    <br/>
    <div id="vis-title">
        <h5>Network analysis of user-to-user interactions on posts tagged:</h5>
        <fieldset style=" margin-top:-3px;">
            <input type="text" id="search" name="search" value="neo4j">
            <input type="submit" id="submitsearch"/>
        </fieldset>
    </div>
    <div id="legend">
        <div id="legend-1">
            <div class='title'><b>Degree Legend</b></div>
            <svg width="80" height="110" style="margin-left:-50px; ">
                <g>
                    <circle cy="23" cx="20" r="2" color="black"></circle>
                    <text x="40" y="24">Low</text>
                </g>
                <g>
                    <circle cy="40" cx="20" r="4" color="black"></circle>
                    <text x="40" y="44"></text>
                </g>
                <g>
                    <circle cy="60" cx="20" r="6" color="black"></circle>
                    <text x="40" y="64"></text>
                </g>
                <g>
                    <circle cy="80" cx="20" r="8" color="black"></circle>
                    <text x="40" y="84"></text>
                </g>
                <g>
                    <circle cy="100" cx="20" r="10" color="black"></circle>
                    <text x="40" y="104">High</text>
                </g>
            </svg>
        </div>
        <div id="legend-2" style="margin-left:-10px;">
            <div class='title'><b>Betweenness Legend</b></div>
            <p>High</p>
            <img src="..\image\legend.png" height="100" width="20" style="margin-top:-10px;">
            <p>Low</p>

            </svg>

        </div>
    </div>
    <div id="container"></div>
    <div id="sidebar">
        <div id='charts'>
            <div class='title'><b>Date</b></div>
            <button id="stop" class="btn btn-secondary">Stop animation</button>
            <div id='total-nodes' class="stats"></div>
            <div id='total-edges' class="stats"></div>
            <div id='density' class="stats"></div>
            <div id="isrunning"></div>
            <div id='date-chart' class='chart'>
                <!--<svg width="960" height="600"></svg>-->

            </div>
        </div>
    </div>

        <div id="right-side-bar">
            <div class="list-group">
                <a href="#" class="list-group-item list-group-item-action" > <b>Betweenness Ranking </b></a>
                <a id="first" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#fff8e2" > 1. </a>
                <a id="second" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#edeeef"> 2. </a>
                <a id="third" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#f9ebe1">3. </a>
                <a id="fourth" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#fff"> 4. </a>
                <a id="fifth" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#fff"> 5. </a>
            </div>

            <div class="list-group">
                <a href="#" class="list-group-item list-group-item-action" > <b>Degree Ranking </b></a>
                <a id="dfirst" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#fff8e2" > 1. </a>
                <a id="dsecond" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#edeeef"> 2. </a>
                <a id="dthird" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#f9ebe1">3. </a>
                <a id="dfourth" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#fff"> 4. </a>
                <a id="dfifth" href="#" target="_blank" class="list-group-item list-group-item-action" style="background-color:#fff"> 5. </a>
            </div>


            <div style="width:280px; margin-top:235px;">
                <br>
                <b>Insights</b>

                <p>
                    High betweenness centrality signify that the user has many in-degree and out-degree interactions, thus information spread across the network is likely to pass through him.
                    High degree centrality shows that the user is influential. In the case of Stackoverflow, these interactions tend to be answering many questions (in thousands per tag), hence high out-degree interactions.

                    Drag the slider across the years to observe changes in betweenness and degree centrality ranking among users.

                    As there are many nodes in each community, please give the visualisation time to load, of up to 5 minutes.
                </p>
            </div>
        </div>
    <script>
    let query = function (statements, transform) {
                var config = {
                    method: 'post',
                    headers: { 'Content-type': 'application/json', 'Accept': 'application/json; charset=utf-8', 'X-stream': true },
                    data: {
                        "statements": statements
                    }
                }
                if (typeof transform !== 'undefined') {
                    config.transformResponse = transform
                }
                // returns promise
                return axios('http://35.187.249.158:7474/db/data/transaction/commit', config)
            }
    let vis = function (data) {
                let svg = d3.select("svg"),
                    width = +svg.attr("width"),
                    height = +svg.attr("height");

                let color = d3.scaleOrdinal(d3.schemeCategory20);

                let simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(function (d) { return d.UserId; }))
                    .force("charge", d3.forceManyBody())
                    .force("center", d3.forceCenter(width / 2, height / 2));

                let link = svg.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(data.links)
                    .enter().append("line")
                    .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

                function dragended(d) {
                    if (!d3.event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
            }
    let getStatementByTag = function(tag){
        return [
            {
                "statement":"MATCH (t:Tag {TagId: $tag})--(p:Posts) " +
                "WITH p MATCH (from:User)-[r:Comment]->(p)<-[:CREATES]-(to:User) " +
                "RETURN {from:from,rel:r,to:to}",
                "parameters": {
                    "tag":tag
                },
                "resultDataContents":["row"],
            },
            {
                "statement": "MATCH (t:Tag {TagId: $tag})--(p:Posts) " +
                "WITH p MATCH (from:User)-[r:LAST_EDITED]->(p)<-[:CREATES]-(to:User)" +
                "RETURN {from:from, rel:r, to:to}",
                "parameters":{
                    "tag":tag
                },
                "resultDataContents":["row"]
            },
            {
                "statement":"MATCH (t:Tag {TagId: $tag})--(p:Posts) "+
                "WITH p MATCH (from:User)-[:CREATES]-(a:Posts)-[r:ANSWERS]->(p)-[:CREATES]-(to:User)"+
                "RETURN {from:from, rel:{CreationDate:a.CreationDate}, to:to}",
                "parameters":{
                    "tag":tag
                },
                "resultDataContents":["row"]
            },
            {
                "statement":"MATCH (t:Tag {TagId: $tag})--(p:Posts) "+
                "WITH p MATCH (from:User)-[:CREATES]-(a:Posts)<-[r:PARENT_OF]-(p)-[:CREATES]-(to:User)"+
                "RETURN {from:from, rel:{CreationDate:a.CreationDate}, to:to}",
                "parameters":{
                    "tag":tag
                },
                "resultDataContents":["row"]
            }
        ]
    }
    let sigmavis = function(data){
        //JSNETWORKX GRAPH
        var G = new jsnx.Graph();
        data.nodes.forEach((d, i, a) => {
            G.addNode(d.UserId)
        });

        data.links.forEach((d,i) => {
            G.addEdge(d.source, d.target)
        });

        let results = new jsnx.genBetweennessCentrality(G);

        sigma.settings.nodesPowRatio = 0.5;
        sigma.settings.autoRescale = false;

        let s = new sigma({
//            renderer: {
//                container: document.getElementById('container'),
//                type: 'canvas',
//                settings: {
//                    defaultNodeColor: '#ec5148',
//                    edgeColor: 'default',
//                    defaultEdgeColor: '#ccc',
//                    animationsTime: 5000,
//                    //drawLabels: false,
//                    //batchEdgesDrawing: true,
//                    hideEdgesOnMove: true,
//                    sideMargin: 1,
//                    labelThreshold: 8,
//                }
//            },
        });

        data.nodes.forEach((d, i, a) => {
            s.graph.addNode({
                id: d.UserId,
                label: d.DisplayName,
                x: Math.random() * 1000,
                y:Math.random() * 1000,
                size: 1,
            })
        })

        data.links.forEach((d,i) => {
            s.graph.addEdge({
                id: i,
                source: d.source,
                target:d.target
            })
        })

        results.then(function(a){
            let obj = a._stringValues
            let minVal = Math.sqrt(Math.min.apply(null,Object.values(obj)))
            let maxVal = Math.sqrt(Math.max.apply(null,Object.values(obj)))
            var colorSeq = d3.scaleSequential()
                .domain([minVal,maxVal])
                .interpolator(d3.interpolateRgb.gamma(3.0)("red","blue"))
            Object.keys(obj).forEach(function(k) {
//                console.log(k, obj[k])
                s2.graph.nodes(k).color = colorSeq(Math.sqrt(obj[k]))
                //s.graph.nodes(k).color = colorSeq(obj[k])
            });
            s2.refresh();
        });

        //PAUSE ANIMATION
        isStop = false
        button = document.getElementById('stop')
        button.onclick = () => {
            if (isStop) {
                s2.startForceAtlas2()
                isStop = false
            }else{
                s2.stopForceAtlas2()
                isStop = true
            }
        }

        //NODE SIZE BASED ON DEGREE
        nodeArr = s.graph.nodes().map(v => s.graph.degree(v.id))
        binner = d3.scaleQuantize().domain([Math.min.apply(null,nodeArr), Math.max.apply(null,nodeArr)]).range([2,4,8,16,32])
        s2.graph.nodes().forEach(v => v.size = binner(s.graph.degree(v.id)))
        // Finally, let's ask our sigma instance to refresh:
        s2.refresh();
        s2.configForceAtlas2({

//            worker: true,
//            autoStop: false,
//            background: false,
//            adjustSizes: true,
            gravity:20
        });
        s.startForceAtlas2()


    }
    let barVolumeChart = function(dim, start, end, renderGraph, graph){

        let dates = dim.group(d3.timeDay)
        const formatNumber = d3.format(',d');
        const charts = [
            barChart()
                .dimension(dim)
                .group(dates)
                .round(d3.timeDay.round)
                .x(d3.scaleTime()
                    .domain([start, end])
                    .rangeRound([0, 10 * 90]))
                .filter([new Date(2015,0), new Date(2016,0)])
        ]
        const chart = d3.selectAll('.chart')
            .data(charts);

        function render(method) {
            d3.select(this).call(method);
        }

        // Whenever the brush moves, re-rendering everything.
        function renderAll() {
            chart.each(render);
            // what's this
//            d3.select('#active').text(formatNumber(all.value()));
            renderGraph()
        }
        renderAll();
        function barChart() {
            if (!barChart.id) barChart.id = 0;

            let margin = { top: 10, right: 13, bottom: 20, left: 10 };
            let x;
            let y = d3.scaleLinear().range([100, 0]);
            const id = barChart.id++;
            const axis = d3.axisBottom();
            const brush = d3.brushX();
            let brushDirty;
            let dimension;
            let group;
            let round;
            let gBrush;

            function chart(div) {
                const width = x.range()[1];
                const height = y.range()[0];
                brush.extent([[0, 0], [width, height]]);

                y.domain([0, group.top(1)[0].value]);

                div.each(function () {
                    const div = d3.select(this);
                    let g = div.select('g');

                    // Create the skeletal chart.
                    if (g.empty()) {
                        div.select('.title').append('a')
                            .attr('href', `javascript:reset(${id})`)
                            .attr('class', 'reset')
                            .text('reset')
                            .style('display', 'none');

                        g = div.append('svg')
                            .attr('width', width + margin.left + margin.right)
                            .attr('height', height + margin.top + margin.bottom)
                            .append('g')
                            .attr('transform', `translate(${margin.left},${margin.top})`);

                        g.append('clipPath')
                            .attr('id', `clip-${id}`)
                            .append('rect')
                            .attr('width', width)
                            .attr('height', height);

                        g.selectAll('.bar')
                            .data(['background', 'foreground'])
                            .enter().append('path')
                            .attr('class', d => `${d} bar`)
                            .datum(group.all());

                        g.selectAll('.foreground.bar')
                            .attr('clip-path', `url(#clip-${id})`);

                        g.append('g')
                            .attr('class', 'axis')
                            .attr('transform', `translate(0,${height})`)
                            .call(axis);

                        // Initialize the brush component with pretty resize handles.
                        gBrush = g.append('g')
                            .attr('class', 'brush')
                            .call(brush);

                        gBrush.selectAll('.handle--custom')
                            .data([{ type: 'w' }, { type: 'e' }])
                            .enter().append('path')
                            .attr('class', 'brush-handle')
                            .attr('cursor', 'ew-resize')
                            .attr('d', resizePath)
                            .style('display', 'none');
                    }

                    // Only redraw the brush if set externally.
                    if (brushDirty !== false) {
                        const filterVal = brushDirty;
                        brushDirty = false;

                        div.select('.title a').style('display', d3.brushSelection(div) ? null : 'none');

                        if (!filterVal) {
                            g.call(brush);

                            g.selectAll(`#clip-${id} rect`)
                                .attr('x', 0)
                                .attr('width', width);

                            g.selectAll('.brush-handle').style('display', 'none');
                            renderAll();
                        } else {
                            const range = filterVal.map(x);
                            brush.move(gBrush, range);
                        }
                    }

                    g.selectAll('.bar').attr('d', barPath);
                });

                function barPath(groups) {
                    const path = [];
                    let i = -1;
                    const n = groups.length;
                    let d;
                    while (++i < n) {
                        d = groups[i];
                        path.push('M', x(d.key), ',', height, 'V', y(d.value), 'h9V', height);
                    }
                    return path.join('');
                }

                function resizePath(d) {
                    const e = +(d.type === 'e');
                    const x = e ? 1 : -1;
                    const y = height / 3;
                    return `M${0.5 * x},${y}A6,6 0 0 ${e} ${6.5 * x},${y + 6}V${2 * y - 6}A6,6 0 0 ${e} ${0.5 * x},${2 * y}ZM${2.5 * x},${y + 8}V${2 * y - 8}M${4.5 * x},${y + 8}V${2 * y - 8}`;
                }
            }

            brush.on('start.chart', function () {
                const div = d3.select(this.parentNode.parentNode.parentNode);
                div.select('.title a').style('display', null);
            });

            brush.on('brush.chart', function () {
                const g = d3.select(this.parentNode);
                const brushRange = d3.event.selection || d3.brushSelection(this); // attempt to read brush range
                const xRange = x && x.range(); // attempt to read range from x scale
                let activeRange = brushRange || xRange; // default to x range if no brush range available

                const hasRange = activeRange &&
                    activeRange.length === 2 &&
                    !isNaN(activeRange[0]) &&
                    !isNaN(activeRange[1]);

                if (!hasRange) return; // quit early if we don't have a valid range

                // calculate current brush extents using x scale
                let extents = activeRange.map(x.invert);

                // if rounding fn supplied, then snap to rounded extents
                // and move brush rect to reflect rounded range bounds if it was set by user interaction
                if (round) {
                    extents = extents.map(round);
                    activeRange = extents.map(x);

                    if (
                        d3.event.sourceEvent &&
                        d3.event.sourceEvent.type === 'mousemove'
                    ) {
                        d3.select(this).call(brush.move, activeRange);
                    }
                }

                // move brush handles to start and end of range
                g.selectAll('.brush-handle')
                    .style('display', null)
                    .attr('transform', (d, i) => `translate(${activeRange[i]}, 0)`);

                // resize sliding window to reflect updated range
                g.select(`#clip-${id} rect`)
                    .attr('x', activeRange[0])
                    .attr('width', activeRange[1] - activeRange[0]);

                // filter the active dimension to the range extents
                dimension.filterRange(extents);

                // re-render the other charts accordingly
                renderAll();
            });

            brush.on('end.chart', function () {
                // reset corresponding filter if the brush selection was cleared
                // (e.g. user "clicked off" the active range)
                if (!d3.brushSelection(this)) {
                    reset(id);
                }
            });

            chart.margin = function (_) {
                if (!arguments.length) return margin;
                margin = _;
                return chart;
            };

            chart.x = function (_) {
                if (!arguments.length) return x;
                x = _;

                axis.scale(x);
                return chart;
            };

            chart.y = function (_) {
                if (!arguments.length) return y;
                y = _;
                return chart;
            };

            chart.dimension = function (_) {
                if (!arguments.length) return dimension;
                dimension = _;
                return chart;
            };

            chart.filter = _ => {
                if (!_) dimension.filterAll();
                brushDirty = _;
                return chart;
            };

            chart.group = function (_) {
                if (!arguments.length) return group;
                group = _;
                return chart;
            };

            chart.round = function (_) {
                if (!arguments.length) return round;
                round = _;
                return chart;
            };

            chart.gBrush = () => gBrush;

            return chart;
        }
    }
    sigma.classes.graph.addMethod('neighbors', function(nodeId) {
        var k,
            neighbors = {},
            index = this.allNeighborsIndex[nodeId] || {};

        for (k in index)
            neighbors[k] = this.nodesIndex[k];
        return neighbors;
    });
    sigma.classes.graph.addMethod('countOutDeg', function(nodeId){
       return this.outNeighborsCount[nodeId]
    });
    sigma.classes.graph.addMethod('countInDeg', function(nodeId){
       return this.inNeighborsCount[nodeId]
    });
    let s = null
    let s2 = null
    let anotherSigmaVis = function(data){

        s = new sigma()
        s2 = new sigma({
            renderer: {
                container: document.getElementById('container'),
                type: 'canvas',
                settings: {
                    nodesPowRatio: 0.5,
                    autoRescale: false,
                    defaultNodeColor: '#ccc',
                    edgeColor: 'default',
                    defaultEdgeColor: '#ccc',
                    animationsTime: 5000,
                    //drawLabels: false,
                    //batchEdgesDrawing: true,
                    hideEdgesOnMove: true,
                    sideMargin: 1,
                    labelThreshold: 8
                }
            },
        });

        // When the stage is clicked, we just color each
        // node and edge with its original color.
        // Create cross filter on link edge
        let edgeCrossFilter = crossfilter(data.links)

        // Create nodes list using sigma, dummy graph for referencing nodes
        s2.bind('clickStage', function(e) {
            console.log(e)
            s2.graph.nodes().forEach(function(n) {
                n.color = s.graph.nodes(n.id).color;
            });

            s2.graph.edges().forEach(function(e) {
                e.color = e.originalColor;
            });

            // Same as in the previous event:
            s2.refresh();
        });
        s2.bind('clickNode', function(e) {
            console.log(e)
            var nodeId = e.data.node.id,
                toKeep = s2.graph.neighbors(nodeId);
            toKeep[nodeId] = e.data.node;

            s2.graph.nodes().forEach(function(n) {
                if (toKeep[n.id])
                    n.color = n.color
                else
                    n.color = '#eee';
            });

            s2.graph.edges().forEach(function(e) {
                if (toKeep[e.source] && toKeep[e.target])
                    e.color = e.originalColor;
                else
                    e.color = '#eee';
            });
            // Since the data has been modified, we need to
            // call the refresh method to make the colors
            // update effective.
            s2.refresh();
        });

        data.nodes.forEach((d, i, a) => {
            s.graph.addNode({
                id: d.UserId,
                label: d.DisplayName,
                x: Math.random() * 1000,
                y:Math.random() * 1000,
                size: 1
            })
        })
        // Create dimmension by time.
        let edgeByDate = edgeCrossFilter.dimension(function(d){
            var t = new Date(1970,0)
            t.setSeconds(d.time)
            return t
        })
        edgeByDate.filter([new Date(2016,0), new Date(2017,0)])
        barVolumeChart(edgeByDate, new Date(2009,0), new Date(2017,9), render, s2)

        // Highlight nodes and edges on click.
        function render(){
            // Get all edges within filtered date.
            let cy = cytoscape()
            let graphObjects = edgeByDate.top(Infinity)
            let filteredCF = crossfilter(edgeCrossFilter.allFiltered())
            let pairDim = filteredCF.dimension(d=> [d.source,d.target])
            //get people with top 10 highest degrees
            let pairList = pairDim.group().reduceCount().top(Infinity)
            let nodesInTopN = pairList.reduce((a,v)=>{
                a[v.key[0]] = 0
                a[v.key[1]] = 0
                return a
            },{})
            let sourceList = graphObjects.map(v => v.source).filter((v,i,arr) => i==arr.indexOf(v))
            let targetList = graphObjects.map(v => v.target).filter((v,i,arr) => i==arr.indexOf(v))
            let allList = sourceList.concat(targetList)
            let uniqueNodes = allList.filter((v,i,arr) => i==arr.indexOf(v))
                .filter(o => o in nodesInTopN)
            console.log(uniqueNodes)
            s2.graph.clear()
            uniqueNodes.forEach(r => s2.graph.addNode({
                id: r,
                label: s.graph.nodes(r).label,
                x: Math.random() * 1000,
                y:Math.random() * 1000,
                size: 1
            }))

            pairList.forEach((r,i) => {
                s2.graph.addEdge({
                    id: i,
                    source: r.key[0],
                    target: r.key[1],
                    size: r.value * 10
                })
            })

            uniqueNodes.forEach(r => {
                cy.add({data:{
                    id: r
                }})
            })

            pairList.forEach((r,i) => {
                cy.add({data:{
                    id:i,
                    source: r.key[0],
                    target: r.key[1]
                }})
            })
            //JSNETWORKX GRAPH
            var G = new jsnx.DiGraph();
            uniqueNodes.forEach((d, i, a) => {
                G.addNode(d)
            });
            pairList.forEach((d,i) => {
                G.addEdge(d.key[0], d.key[1])
            });

            let results = new jsnx.genBetweennessCentrality(G);
            // use out-going degrees
            nodeArr = s2.graph.nodes().map(v => s2.graph.countOutDeg(v.id))
            let topDegrees = s2.graph.nodes()
                .sort((a, b) => s2.graph.countOutDeg(b.id) - s2.graph.countOutDeg(a.id))
                .slice(0, 5);
            console.log(topDegrees)
            binner = d3.scaleQuantize().domain([Math.min.apply(null,nodeArr), Math.max.apply(null,nodeArr)]).range([2,4,8,16,32])
            s2.graph.nodes().forEach(v => v.size = binner(s2.graph.countOutDeg(v.id)))

            results.then(function(a){
                let obj = a._stringValues
                let minVal = Math.sqrt(Math.min.apply(null,Object.values(obj)))
                let maxVal = Math.sqrt(Math.max.apply(null,Object.values(obj)))
                let colorSeq = d3.scaleSequential()
                    .domain([minVal,maxVal])
                    .interpolator(d3.interpolateRgb.gamma(3.0)("grey","orange"))
                Object.keys(obj).forEach(function(k) {
                    s.graph.nodes(k).color = colorSeq(Math.sqrt(obj[k]))
                    s2.graph.nodes(k).color = colorSeq(Math.sqrt(obj[k]))
                });

                let topData = Object.keys(obj).sort(function(a, b){return obj[b]-obj[a]}).slice(0, 5);

                var first = document.getElementById("first");
                var second = document.getElementById("second");
                var third = document.getElementById("third");
                var fourth = document.getElementById("fourth");
                var fifth = document.getElementById("fifth");

                first.innerHTML = "1. " + s.graph.nodes(topData[0]).label
                second.innerHTML = "2. " + s.graph.nodes(topData[1]).label
                third.innerHTML = "3. " + s.graph.nodes(topData[2]).label
                fourth.innerHTML = "4. " + s.graph.nodes(topData[3]).label
                fifth.innerHTML = "5. " + s.graph.nodes(topData[4]).label

                first.href = "https://stackoverflow.com/users/" + topData[0]
                second.href = "https://stackoverflow.com/users/" + topData[1]
                third.href = "https://stackoverflow.com/users/" + topData[2]
                fourth.href = "https://stackoverflow.com/users/" + topData[3]
                fifth.href = "https://stackoverflow.com/users/" + topData[4]

                var dfirst = document.getElementById("dfirst");
                var dsecond = document.getElementById("dsecond");
                var dthird = document.getElementById("dthird");
                var dfourth = document.getElementById("dfourth");
                var dfifth = document.getElementById("dfifth");

                dfirst.innerHTML = "1. " + topDegrees[0].label
                dsecond.innerHTML = "2. " + topDegrees[1].label
                dthird.innerHTML = "3. " + topDegrees[2].label
                dfourth.innerHTML = "4. " + topDegrees[3].label
                dfifth.innerHTML = "5. " + topDegrees[4].label

                dfirst.href = "https://stackoverflow.com/users/" + topDegrees[0].id
                dsecond.href = "https://stackoverflow.com/users/" + topDegrees[1].id
                dthird.href = "https://stackoverflow.com/users/" + topDegrees[2].id
                dfourth.href = "https://stackoverflow.com/users/" + topDegrees[3].id
                dfifth.href = "https://stackoverflow.com/users/" + topDegrees[4].id

                document.getElementById('total-nodes').innerHTML = "Total nodes: " +s2.graph.nodes().length
                document.getElementById('total-edges').innerHTML = "Total edges: "+s2.graph.edges().length
                document.getElementById('density').innerHTML = "Connected Components: "+ cy.elements('*').components().length
                document.getElementById('isrunning').innerHTML = ""
            });
            s2.refresh()
            if(s2.isForceAtlas2Running() == true){
                s2.killForceAtlas2();
            }
            s2.configForceAtlas2({
                worker: true,
//              autoStop: 10,
//              background: false,
//              adjustSizes: true,
                gravity: 20
            });
            s2.startForceAtlas2();
            setTimeout(()=> s2.stopForceAtlas2(),30000)
        }
    }
    let pipe = function(data) {
        let resultlists = data.results.map(o => o.data).reduce((a,v) => a.concat(v), [])
        let links = resultlists.filter(o => typeof(o.row[0].rel.CreationDate)!== 'undefined').map(function(o){
            return {
                "source": o.row[0].from.UserId,
                "target": o.row[0].to.UserId,
                "time": o.row[0].rel.CreationDate,
                "key": o.row[0].from.UserId+':'+o.row[0].to.UserId
            }
        })

        let nodesmap = {}
        for(let i = 0; i < resultlists.length; i ++){
            let row = resultlists[i].row[0]
            nodesmap[row.from.UserId] = row.from
            nodesmap[row.to.UserId] = row.to
        }
        let nodes = Object.keys(nodesmap).map(key => nodesmap[key])
        return {
            "nodes":nodes,
            "links":links
        }
    }
    let promise = query(getStatementByTag("neo4j"),[JSON.parse,pipe])
    promise.then((data) => {
        anotherSigmaVis(data.data)
        document.getElementById('isrunning').innerHTML = "Running"
    }).catch(e => console.log(e))

    $("#submitsearch").on('click', function (e) {
        //ajax call here
        let tag = document.getElementById('search').value
        console.log(tag)
        d3.selectAll('#date-chart').html("")
        s.graph.clear()
        s2.graph.clear()
        s2.killForceAtlas2()
        s.refresh()
        s2.refresh()
        let promise = query(getStatementByTag(tag),[JSON.parse,pipe])
        promise.then((data) => {
            anotherSigmaVis(data.data)
            document.getElementById('isrunning').innerHTML = "Running"
        })
            .catch(e => console.log(e))
        //stop form submission
        e.preventDefault();
    });
</script>
</body>
<script>


</script>
</html>